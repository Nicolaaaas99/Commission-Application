<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Commission Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { display: flex; min-height: 100vh; background-color: #f8f9fa; }
        #sidebar { width: 280px; min-height: 100vh; background: #343a40; color: #fff; }
        #sidebar .nav-link { color: #adb5bd; font-size: 1.1rem; padding: 0.75rem 1.5rem; border-left: 3px solid transparent; }
        #sidebar .nav-link:hover { color: #fff; background: #495057; border-left-color: #0d6efd; }
        #sidebar .nav-link.active { color: #fff; font-weight: bold; background: #0d6efd; border-left-color: #fff; }
        #content { flex-grow: 1; padding: 2.5rem; }
        .report-table th, .report-table td { text-align: right; vertical-align: middle; }
        .report-table th:first-child, .report-table td:first-child { text-align: left; }
        .report-table .mono { font-family: 'Courier New', Courier, monospace; }
        .total-row { font-weight: bold; border-top: 2px solid #333; }
        .subtotal-row { font-weight: bold; background-color: #e9ecef; }
        .insurer-row { font-weight: 500; background-color: #f8f9fa; }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #dee2e6; }
        .detail-row td:first-child { padding-left: 4.5rem !important; }
        .insurer-row td:first-child { padding-left: 2.5rem !important; }
        .subtotal-row td:first-child { padding-left: 0.5rem !important; }
        
        /* --- FIX: Arrow Icon CSS Removed --- */
        .toggle-icon { display: inline-block; }

        @media print {
            body { display: block; }
            #sidebar, #report-controls, #report-actions .btn { display: none; }
            #content { padding: 0; }
            .card { box-shadow: none !important; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>
    <nav id="sidebar" class="d-flex flex-column flex-shrink-0 p-3">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
            <i class="bi bi-calculator-fill me-2 fs-4"></i><span class="fs-4">Commission App</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item"><a href="{{ url_for('index') }}" class="nav-link"><i class="bi bi-arrow-left-circle me-2"></i>Back to Main App</a></li>
            <li><a href="#" class="nav-link active"><i class="bi bi-bar-chart-line me-2"></i>Broker Report</a></li>
        </ul>
        <hr>
    </nav>

    <main id="content">
        <h1 class="display-6 border-bottom pb-2 mb-4">Broker Commission Report</h1>

        <div id="report-controls" class="card shadow-sm">
            <div class="card-header"><h2 class="h4 mb-0">Report Filters</h2></div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="company-select" class="form-label">Company:</label>
                        <select id="company-select" class="form-select">
                            <option value="" selected disabled>Loading companies...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="period-select" class="form-label">Commission Period:</label>
                        <select id="period-select" class="form-select" disabled>
                            <option value="" selected disabled>Select a company</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="broker-select" class="form-label">Broker:</label>
                        <select id="broker-select" class="form-select" disabled>
                            <option value="" selected disabled>Select company & period</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="compliance-select" class="form-label">Compliance Status:</label>
                        <select id="compliance-select" class="form-select">
                            <option value="All" selected>All Policies</option>
                            <option value="Yes">Compliant Only</option>
                            <option value="No">Non-Compliant Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="split-select" class="form-label">Split Status:</label>
                        <select id="split-select" class="form-select">
                            <option value="All" selected>All Policies</option>
                            <option value="Split">Split Only</option>
                            <option value="Non-Split">Non-Split Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" id="generate-report-btn" disabled>
                            <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header">
                 <div class="d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">Report Results</h2>
                    <div id="report-actions" class="d-none">
                        <button class="btn btn-sm btn-outline-secondary" id="print-btn" title="Print Report"><i class="bi bi-printer"></i></button>
                        <button class="btn btn-sm btn-outline-success" id="excel-btn" title="Export to Excel"><i class="bi bi-file-earmark-spreadsheet"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="email-btn" title="Share via Email"><i class="bi bi-envelope"></i></button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="report-container" class="table-responsive">
                    <p class="text-center text-muted" id="report-placeholder">Please select filters and click "Generate Report" to see the results.</p>
                    <table class="table table-hover report-table d-none">
                        <thead>
                            <tr>
                                <th>Row Labels</th>
                                <th>Policy Holder</th>
                                <th>Split %</th>
                                <th>AmntExcl</th>
                                <th>CommAmntExcl</th>
                                <th>ResCommAmnt</th>
                                <th>CommPaidAmnt</th>
                            </tr>
                        </thead>
                        <tbody id="report-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const companySelect = document.getElementById('company-select');
    const periodSelect = document.getElementById('period-select');
    const brokerSelect = document.getElementById('broker-select');
    const complianceSelect = document.getElementById('compliance-select');
    const splitSelect = document.getElementById('split-select');
    const generateBtn = document.getElementById('generate-report-btn');
    const reportTable = document.querySelector('.report-table');
    const reportBody = document.getElementById('report-body');
    const reportPlaceholder = document.getElementById('report-placeholder');
    const reportActions = document.getElementById('report-actions');
    let rawReportData = [];

    const formatNumber = (num) => parseFloat(num).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const sanitize = (str) => String(str).replace(/[^a-zA-Z0-9]/g, '');

    // --- NEW: Load Companies First ---
    fetch("/api/companies")
        .then(res => res.json())
        .then(companies => {
            companySelect.innerHTML = '<option value="" selected disabled>-- Select a Company --</option>';
            if (Array.isArray(companies)) {
                companies.forEach(company => companySelect.add(new Option(company.name, company.id)));
            }
        }).catch(error => Swal.fire('Error', 'Could not load companies.', 'error'));

    // --- NEW: Load Periods on Company Change ---
    companySelect.addEventListener('change', function() {
        const companyId = this.value;
        periodSelect.disabled = true;
        brokerSelect.disabled = true;
        generateBtn.disabled = true;
        periodSelect.innerHTML = '<option value="" selected disabled>Loading periods...</option>';
        brokerSelect.innerHTML = '<option value="" selected disabled>Select company & period</option>';

        if (!companyId) return;

        Promise.all([
            fetch(`/api/report_periods/${companyId}`).then(res => res.json()),
            fetch("/api/brokers").then(res => res.json())
        ]).then(([periods, brokers]) => {
            periodSelect.innerHTML = '<option value="" selected disabled>-- Select a Period --</option>';
            if (Array.isArray(periods)) {
                periods.forEach(p => periodSelect.add(new Option(p.PeriodYearMonth, p.PeriodId)));
                periodSelect.disabled = false;
            }

            brokerSelect.innerHTML = '<option value="" selected disabled>-- Select a Broker --</option>';
            if (Array.isArray(brokers)) {
                brokers.forEach(broker => brokerSelect.add(new Option(broker.name, broker.id)));
                brokerSelect.disabled = false;
            }
             generateBtn.disabled = false;
        }).catch(error => Swal.fire('Error', 'Could not load periods or brokers.', 'error'));
    });

    generateBtn.addEventListener('click', function() {
        const brokerId = brokerSelect.value;
        const complianceStatus = complianceSelect.value;
        const splitStatus = splitSelect.value;
        const periodId = periodSelect.value; // NEW

        if (!brokerId || !periodId) { // NEW check for period
            Swal.fire('Filter Missing', 'Please select a company, period, and broker.', 'warning');
            return;
        }

        reportPlaceholder.textContent = 'Generating report...';
        reportPlaceholder.classList.remove('d-none');
        reportTable.classList.add('d-none');
        reportActions.classList.add('d-none');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

        // UPDATED: API call with all filters, including period_id
        fetch(`/api/broker_report/${brokerId}?compliance=${complianceStatus}&split_status=${splitStatus}&period_id=${periodId}`)
            .then(response => response.json())
            .then(data => {
                if (!Array.isArray(data)) throw new Error(data.message || 'Invalid data');
                rawReportData = data;
                if (data.length === 0) {
                    reportPlaceholder.textContent = 'No commission data found for the selected criteria.';
                    return;
                }
                buildInteractiveReport(data);
                reportPlaceholder.classList.add('d-none');
                reportTable.classList.remove('d-none');
                reportActions.classList.remove('d-none');
            })
            .catch(error => {
                reportPlaceholder.textContent = `Error: ${error.message}`;
                Swal.fire('Error!', `Could not generate the report. ${error.message}`, 'error');
            })
            .finally(() => {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-file-earmark-text me-2"></i>Generate Report';
            });
    });

    function buildInteractiveReport(data) {
        // This function remains largely the same
        const groupedData = new Map();
        const grandTotals = { AmntExcl: 0, CommAmntExcl: 0, ResCommAmnt: 0, CommPaidAmnt: 0 };
        const zeroTemplate = { AmntExcl: 0, CommAmntExcl: 0, ResCommAmnt: 0, CommPaidAmnt: 0 };
        const sumFields = Object.keys(grandTotals);

        data.forEach(item => {
            const type = item.PolicyInsuranceType;
            const insurer = item.PolicyInsurerName;
            const numericItem = { AmntExcl: parseFloat(item.AmntExcl), CommAmntExcl: parseFloat(item.CommAmntExcl), ResCommAmnt: parseFloat(item.ResCommAmnt), CommPaidAmnt: parseFloat(item.CommPaidAmnt) };
            if (!groupedData.has(type)) groupedData.set(type, { totals: { ...zeroTemplate }, byInsurer: new Map() });
            const typeGroup = groupedData.get(type);
            if (!typeGroup.byInsurer.has(insurer)) typeGroup.byInsurer.set(insurer, { totals: { ...zeroTemplate }, policies: [] });
            const insurerGroup = typeGroup.byInsurer.get(insurer);
            sumFields.forEach(key => { grandTotals[key] += numericItem[key]; typeGroup.totals[key] += numericItem[key]; insurerGroup.totals[key] += numericItem[key]; });
            insurerGroup.policies.push(item);
        });

        let html = '';
        groupedData.forEach((typeData, type) => {
            const typeId = sanitize(type);
            html += renderRow(type, typeData.totals, `subtotal-row`, `group-${typeId}`);
            typeData.byInsurer.forEach((insurerData, insurer) => {
                const insurerId = sanitize(insurer);
                html += renderRow(insurer, insurerData.totals, `insurer-row collapse group-${typeId}`, `group-${typeId}-${insurerId}`);
                insurerData.policies.forEach(policy => {
                    html += renderRow(policy.PolicyNumber, policy, `detail-row collapse group-${typeId}-${insurerId}`, null, { holder: policy.PolicyHolder, split: policy.PolicySplitPercent });
                });
            });
        });

        html += renderRow('Grand Total', grandTotals, 'total-row');
        reportBody.innerHTML = html;
        
        // --- IMPROVED: Click handler for plus/minus toggle ---
        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', function() {
                const icon = this.querySelector('.toggle-icon');
                if (!icon) return;
                
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);

                if (!isExpanded) {
                    icon.classList.remove('bi-plus-lg');
                    icon.classList.add('bi-dash-lg');
                } else {
                    icon.classList.remove('bi-dash-lg');
                    icon.classList.add('bi-plus-lg');
                }
            });
        });
    }
    
    // --- IMPROVED: renderRow function with plus/minus icon ---
    function renderRow(label, data, cssClass, target, details = { holder: '', split: '' }) {
        const isClickable = !!target;
        // Use a plus icon for expandable rows
        const icon = isClickable ? '<i class="bi bi-plus-lg toggle-icon me-2"></i>' : '';
        const clickableClass = isClickable ? 'clickable-row' : '';
        const targetAttr = isClickable ? `data-bs-toggle="collapse" data-bs-target=".${target}" aria-expanded="false"` : '';
        
        return `
            <tr class="${cssClass} ${clickableClass}" ${targetAttr}>
                <td>${icon}${label}</td>
                <td>${details.holder}</td>
                <td class="mono">${details.split ? (details.split * 100).toFixed(2) + '%' : ''}</td>
                <td class="mono">${formatNumber(data.AmntExcl)}</td>
                <td class="mono">${formatNumber(data.CommAmntExcl)}</td>
                <td class="mono">${formatNumber(data.ResCommAmnt)}</td>
                <td class="mono">${formatNumber(data.CommPaidAmnt)}</td>
            </tr>`;
    }

    // --- ACTION BUTTONS ---
    document.getElementById('print-btn').addEventListener('click', () => window.print());
    document.getElementById('email-btn').addEventListener('click', () => { /* ... email logic ... */ });
    document.getElementById('excel-btn').addEventListener('click', () => { /* ... excel logic ... */ });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>