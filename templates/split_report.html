<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Split History Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { display: flex; min-height: 100vh; background-color: #f8f9fa; }
        #sidebar { width: 280px; min-height: 100vh; background: #343a40; color: #fff; }
        #sidebar .nav-link { color: #adb5bd; font-size: 1.1rem; padding: 0.75rem 1.5rem; border-left: 3px solid transparent; }
        #sidebar .nav-link:hover { color: #fff; background: #495057; border-left-color: #0d6efd; }
        #sidebar .nav-link.active { color: #fff; font-weight: bold; background: #0d6efd; border-left-color: #fff; }
        #content { flex-grow: 1; padding: 2.5rem; }
    </style>
</head>
<body>
    <nav id="sidebar" class="d-flex flex-column flex-shrink-0 p-3">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
            <i class="bi bi-calculator-fill me-2 fs-4"></i><span class="fs-4">Commission App</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item"><a href="{{ url_for('index') }}" class="nav-link"><i class="bi bi-arrow-left-circle me-2"></i>Back to Main App</a></li>
            <li><a href="#" class="nav-link active"><i class="bi bi-clock-history me-2"></i>Split History Report</a></li>
        </ul>
        <hr>
    </nav>

    <main id="content">
        <h1 class="display-6 border-bottom pb-2 mb-4">Policy Split History Report</h1>

        <div class="card shadow-sm">
            <div class="card-header"><h2 class="h4 mb-0">Report Filters</h2></div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="start-date" class="form-label">Start Date:</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="end-date" class="form-label">End Date:</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" id="generate-report-btn">
                            <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-4">
            <div class="card-header"><h2 class="h4 mb-0">Report Results</h2></div>
            <div class="card-body">
                <div id="report-container" class="table-responsive">
                    <p class="text-center text-muted" id="report-placeholder">Please select a date range and click "Generate Report".</p>
                    <table class="table table-hover d-none" id="report-table">
                        <thead>
                            <tr>
                                <th>Policy Number</th>
                                <th>Policy Holder</th>
                                <th>Broker Name</th>
                                <th>Split %</th>
                                <th>User Name</th>
                                <th>Date Stamp</th>
                            </tr>
                        </thead>
                        <tbody id="report-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const generateBtn = document.getElementById('generate-report-btn');
    const reportTable = document.getElementById('report-table');
    const reportBody = document.getElementById('report-body');
    const reportPlaceholder = document.getElementById('report-placeholder');

    // Set default dates (e.g., this month)
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('start-date').valueAsDate = firstDayOfMonth;
    document.getElementById('end-date').valueAsDate = today;

    generateBtn.addEventListener('click', function() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (!startDate || !endDate) {
            Swal.fire('Filter Missing', 'Please select both a start and end date.', 'warning');
            return;
        }

        reportPlaceholder.textContent = 'Generating report...';
        reportPlaceholder.classList.remove('d-none');
        reportTable.classList.add('d-none');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

        fetch(`/api/split_history_report?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success === false || !Array.isArray(data)) {
                    throw new Error(data.message || 'Invalid data from server');
                }
                if (data.length === 0) {
                    reportPlaceholder.textContent = 'No split history found for the selected date range.';
                    reportBody.innerHTML = '';
                    return;
                }

                let html = '';
                data.forEach(row => {
                    const splitPercent = (parseFloat(row.SplitPercent) * 100).toFixed(2) + '%';
                    const dateStamp = new Date(row.SplitDateStamp).toLocaleString('en-ZA');
                    html += `
                        <tr>
                            <td>${row.PolicyNumber}</td>
                            <td>${row.PolicyHolder}</td>
                            <td>${row.BrokerName}</td>
                            <td>${splitPercent}</td>
                            <td>${row.SplitUserName}</td>
                            <td>${dateStamp}</td>
                        </tr>
                    `;
                });
                reportBody.innerHTML = html;
                reportPlaceholder.classList.add('d-none');
                reportTable.classList.remove('d-none');
            })
            .catch(error => {
                reportPlaceholder.textContent = `Error: ${error.message}`;
                Swal.fire('Error!', `Could not generate the report. ${error.message}`, 'error');
            })
            .finally(() => {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-file-earmark-text me-2"></i>Generate Report';
            });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>